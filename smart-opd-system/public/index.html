
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Smart OPD Queue System</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="css/style.css">
</head>
<body class="bg">

	<main class="center-screen card-animate">
		<div class="brand">
			<img src="assets/logo.svg" alt="logo" class="logo">
			<div>
				<h1 class="title">Smart OPD Queue System</h1>
				<p class="tagline">Reducing Hospital Waiting Time with Technology</p>
			</div>
		</div>

		<div class="auth-grid">
			<section class="panel">
				<h2>Login</h2>
				<input id="loginEmail" type="email" placeholder="Email" />
				<input id="loginPassword" type="password" placeholder="Password" />
				<button id="loginBtn" class="btn primary">Sign in</button>
				<p id="msg" class="muted"></p>
			</section>

			<section class="panel muted-panel">
				<h3>New Patient?</h3>
				<input id="name" placeholder="Full name" />
				<input id="emailReg" type="email" placeholder="Email" />
				<input id="passwordReg" type="password" placeholder="Password" />
				<button id="registerBtn" class="btn secondary">Register as Patient</button>
				<p class="muted">Doctors and admins should be created in the Emulator UI for safety.</p>
			</section>
		</div>
	</main>

	<div id="loading" class="loading hidden"><div class="spinner"></div></div>

	<script type="module">
	import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
	import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
	import { getFirestore, doc, setDoc, getDoc, serverTimestamp, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

	const firebaseConfig = {
		apiKey: "AIzaSyC6ALCXtrsYoZ2RrIwAQMLLHX30ztYTnpo",
		authDomain: "studio-1828532244-e822b.firebaseapp.com",
		projectId: "studio-1828532244-e822b",
		storageBucket: "studio-1828532244-e822b.appspot.com",
		messagingSenderId: "722776494280",
		appId: "1:722776494280:web:a3fef849e76f15a98995fd"
	};

	const app = initializeApp(firebaseConfig);
	const auth = getAuth(app);
	const db = getFirestore(app);

	 if (location.hostname === '127.0.0.1' || location.hostname === 'localhost') {
		// Emulator: use fixed localhost ports (auth:9099, firestore:8080)
		connectAuthEmulator(auth, 'http://127.0.0.1:9099');
		connectFirestoreEmulator(db, '127.0.0.1', 8080);
		console.log('[emulator] connected to localhost (auth:9099, firestore:8080)');
	 }

	const loginBtn = document.getElementById('loginBtn');
	const registerBtn = document.getElementById('registerBtn');
	const msg = document.getElementById('msg');

	loginBtn.addEventListener('click', async () => {
		msg.textContent = '';

		const email = document.getElementById('loginEmail').value.trim();
		const password = document.getElementById('loginPassword').value;
		if (!email || !password) return msg.textContent = 'Email and password required';
		showLoading(true);
		try {
			const cred = await signInWithEmailAndPassword(auth, email, password);
			const snap = await getDoc(doc(db, 'users', cred.user.uid));
			const role = snap.exists() ? snap.data().role : null;
			if (role === 'patient') return location.href = 'patient.html';
			if (role === 'doctor') return location.href = 'doctor.html';
			if (role === 'admin') return location.href = 'admin.html';
			msg.textContent = 'No role assigned. Please set role in Emulator UI.';
			await auth.signOut();
		} catch (e) { msg.textContent = e.message; } finally { showLoading(false); }
	});

	registerBtn.addEventListener('click', async () => {
		msg.textContent = '';

		const name = document.getElementById('name').value.trim();
		const email = document.getElementById('emailReg').value.trim();
		const password = document.getElementById('passwordReg').value;
		if (!name || !email || !password) return msg.textContent = 'All fields required';
		showLoading(true);
		try {
			const cred = await createUserWithEmailAndPassword(auth, email, password);
			await setDoc(doc(db, 'users', cred.user.uid), { name, email, role: 'patient', createdAt: serverTimestamp() });
			location.href = 'patient.html';
		} catch (e) { msg.textContent = e.message; } finally { showLoading(false); }
	});

	onAuthStateChanged(auth, async user => {
		if (!user) return;
		showLoading(true);
		console.log('[debug] onAuthStateChanged - uid:', user.uid);
		let snap = null;
		try {
			console.log('[debug] fetching user doc for', user.uid);
			snap = await getDoc(doc(db, 'users', user.uid));
		} catch (err) {
			console.error('[debug] error fetching user doc:', err);
			// Hide loader and sign out to recover
			showLoading(false);
			try { await auth.signOut(); } catch(e){}
			return;
		}

		const role = snap && snap.exists() ? snap.data().role : null;
		console.log('[debug] user role:', role);
		if (role === 'patient') return location.href = 'patient.html';
		if (role === 'doctor') return location.href = 'doctor.html';
		if (role === 'admin') return location.href = 'admin.html';
		showLoading(false);
	});

	function showLoading(v){document.getElementById('loading').classList.toggle('hidden', !v)}

	</script>

</body>
</html>

