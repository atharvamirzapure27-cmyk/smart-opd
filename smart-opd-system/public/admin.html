<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <header class="navbar">
    <div class="brand">
      <img src="assets/logo.svg" class="logo" alt="logo">
      <div>
        <div class="title">Smart OPD Queue System</div>
        <div class="tagline">Reducing Hospital Waiting Time with Technology</div>
      </div>
    </div>
    <div class="nav-right">
      <div id="userRole" class="small muted">Loading...</div>
      <button id="logoutBtn" class="btn nav-logout">Logout</button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <h2 class="page-title">System Overview</h2>
        <div class="stats-row">
          <div class="card stat-card">
            <div class="small muted">Total Patients</div>
            <h3 id="totalPatients">0</h3>
          </div>
          <div class="card stat-card">
            <div class="small muted">Total Doctors</div>
            <h3 id="totalDoctors">0</h3>
          </div>
          <div class="card stat-card">
            <div class="small muted">Total Appointments</div>
            <h3 id="totalAppointments">0</h3>
          </div>
        </div>
        <div style="margin-top:12px"><button id="resetBtn" class="btn ghost">Reset Queue (demo)</button></div>
        <div style="margin-top:16px" class="card">
          <h4 class="small muted">Add Doctor</h4>
          <input id="newDocName" placeholder="Full name" />
          <input id="newDocEmail" placeholder="Email" />
          <input id="newDocPass" placeholder="Password" />
          <div style="margin-top:8px"><button id="addDoctorBtn" class="btn primary">Add Doctor</button></div>
          <div class="muted small">This creates an Auth user in the Emulator and a Firestore `users` doc with role=doctor.</div>
        </div>
      </section>

      <aside>
        <div class="card">
          <h3 class="small muted">OPD-wise Queue (waiting)</h3>
          <div id="opdList"></div>
        </div>
      </aside>
    </div>
  </main>

  <div id="loading" class="loading hidden"><div class="spinner"></div></div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  connectAuthEmulator
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  serverTimestamp,
  getDoc,
  connectFirestoreEmulator
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6ALCXtrsYoZ2RrIwAQMLLHX30ztYTnpo",
  authDomain: "studio-1828532244-e822b.firebaseapp.com",
  projectId: "studio-1828532244-e822b",
  storageBucket: "studio-1828532244-e822b.appspot.com",
  messagingSenderId: "722776494280",
  appId: "1:722776494280:web:a3fef849e76f15a98995fd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Emulator: fixed localhost ports (auth:9099, firestore:8080)
if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
  connectAuthEmulator(auth, 'http://127.0.0.1:9099');
  connectFirestoreEmulator(db, '127.0.0.1', 8080);
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = 'index.html';
  const profRef = doc(db, 'users', user.uid);
  const profSnap = await getDoc(profRef).catch(()=>null);
  if (!profSnap || !profSnap.exists() || profSnap.data().role !== 'admin') {
    alert('Access denied');
    await signOut(auth);
    return window.location.href = 'index.html';
  }
  document.getElementById('userRole').innerText = `Admin: ${profSnap.data().name || user.email}`;
  subscribeStats();
  subscribeOpdCounts();
});

async function subscribeStats() {
  const usersSnap = await getDocs(collection(db, 'users'));
  let patients = 0, doctors = 0;
  usersSnap.forEach(d => {
    const r = d.data().role;
    if (r === 'patient') patients++;
    if (r === 'doctor') doctors++;
  });
  totalPatients.innerText = patients;
  totalDoctors.innerText = doctors;

  const apptSnap = await getDocs(collection(db, 'appointments'));
  totalAppointments.innerText = apptSnap.size;
}

function subscribeOpdCounts() {
  const q = query(collection(db, 'appointments'));
  onSnapshot(q, snap => {
    const counts = {};
    snap.forEach(d => {
      const a = d.data();
      if (a.status === 'waiting') {
        counts[a.opd] = (counts[a.opd] || 0) + 1;
      }
    });
    opdList.innerHTML = '';
    for (const opd in counts) {
      const div = document.createElement('div');
      div.className = 'opd-row';
      div.innerText = `${opd}: ${counts[opd]} waiting`;
      opdList.appendChild(div);
    }
    if (Object.keys(counts).length === 0) opdList.innerHTML = '<div>No waiting patients</div>';
  });
}

async function resetQueue() {
  if (!confirm('Reset all appointments to waiting?')) return;
  const snap = await getDocs(collection(db, 'appointments'));
  const updates = [];
  snap.forEach(d => {
    updates.push(updateDoc(doc(db, 'appointments', d.id), { status: 'waiting' }));
  });
  await Promise.all(updates);
  alert('Queue reset');
}

document.getElementById('resetBtn').addEventListener('click', resetQueue);
document.getElementById('addDoctorBtn').addEventListener('click', async () => {
  const name = document.getElementById('newDocName').value.trim();
  const email = document.getElementById('newDocEmail').value.trim();
  const pass = document.getElementById('newDocPass').value;
  if (!name || !email || !pass) return alert('All fields required');
  showLoading(true);
  try {
    // Create auth user in emulator via REST (no sign-in)
    const res = await fetch('http://127.0.0.1:9099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const body = await res.json();
    if (!res.ok) throw new Error(body.error ? JSON.stringify(body.error) : 'Auth create failed');
    // write user doc
    await updateDoc(doc(db, 'users', body.localId), { name, email, role: 'doctor', createdAt: serverTimestamp() });
    alert('Doctor created');
  } catch (e) { console.error(e); alert('Create doctor failed: '+e.message); }
  showLoading(false);
});
document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await signOut(auth); location.href='index.html' });

function showLoading(v){document.getElementById('loading').classList.toggle('hidden', !v)}
</script>

</body>
</html>
